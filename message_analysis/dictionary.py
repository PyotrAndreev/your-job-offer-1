state_patterns = {
	# 1. Отклик отправлен (начальное состояние)
	"отклик отправлен": [],

	# 2. Отказ при подаче
	"отказ при подаче": [
		"отказ", "отказать", "отказываем", "отклонили", "отклоняем",
		"не готовы", "не подходите", "не соответствуете", "не подходит ваш опыт",
		"к сожалению", "с сожалением сообщаем", "решили отказать",
		"выбрали другого кандидата", "нашли более подходящего специалиста",
		"вакансия закрыта", "пока нет подходящих вакансий",
		"не наш профиль", "не вписываетесь", "не подходим друг другу",
		"не ваш уровень", "не под требования", "не под наш стек технологий",
		"не под наши ожидания", "не под условия", "не под зарплатные ожидания",
		"не берем", "не сможем сотрудничать", "не готовы двигаться дальше"
	],

	# 3. Отклик интересен (приглашение на второй этап)
	"отклик был интересен работодателю": [
		"приглашение", "приглашаем", "интересен ваш отклик", "заинтересовались",
		"хотим продолжить", "переходим к следующему этапу", "следующий шаг",
		"тестовое задание", "просим выполнить тестовое", "анкета", "опросник",
		"дополнительные вопросы", "хотим узнать больше", "уточнить детали",
		"давайте познакомимся ближе", "продолжим общение", "следующая стадия",
		"передадим ваш отклик", "отправили на рассмотрение", "рассматриваем вас",
		"передали руководителю", "отдел заинтересовался", "нравится ваш опыт",
		"подходите нам", "соответствуете требованиям", "интересный кандидат",
		"+79"
	],

	# 4. Приглашение на собеседование
	"приглашен на собеседование": [
		"собеседование", "интервью", "встреча", "разговор", "созвон",
		"приглашаем на собеседование", "хотим пообщаться", "давайте обсудим",
		"готовы провести интервью", "можем назначить встречу", "выберем время",
		"свободны ли вы", "доступны ли вы", "удобное время", "дата и время",
		"платформа для встречи", "zoom", "teams", "google meet", "очно", "онлайн",
		"техническое собеседование", "с HR", "с руководителем", "командой",
		"первичное интервью", "второй этап", "финальное собеседование",
		"назначим время", "согласуем график", "выберите удобный слот",
		"календарь для записи", "ссылка на встречу", "подключиться по ссылке"
	],

	# 5. Отказ после собеседования
	"отказ после собеседования": [
		"после собеседования", "по итогам интервью", "после общения",
		"к сожалению", "с сожалением сообщаем", "решили не продолжать",
		"не подошли", "не подходит", "не соответствуете", "не наш вариант",
		"выбрали другого кандидата", "нашли более подходящего",
		"не готовы предложить оффер", "не продолжим сотрудничество",
		"не под наши ожидания", "не сошлись", "не под требования",
		"не под уровень", "не под команду", "не под корпоративную культуру",
		"не под условия работы", "не под зарплатные ожидания",
		"не под график работы", "не под локацию", "другой кандидат ближе",
		"более релевантный опыт", "более подходящий специалист"
	],

	# 6. Ожидание заполнения заявки
	"ожидает заполнения заявки на внешнем сайте": [
		"заполните форму", "анкету", "опросник", "регистрация", "профиль",
		"ссылка", "перейдите по ссылке", "на сайте", "в системе", "платформа",
		"кабинет кандидата", "личный кабинет", "требуется заполнить",
		"необходимо зарегистрироваться", "дополнительная информация",
		"указать данные", "внести сведения", "заполнить профиль",
		"прикрепить документы", "скачать форму", "загрузить резюме",
		"подтвердить email", "верификация", "аккаунт", "логин и пароль",
		"инструкция", "руководство", "гайд", "портал", "платформа для кандидатов"
	],

	# 7. Диалог заброшен (это состояние наступает при отсутствии контакта +- 10 дней)
	"диалог заброшен": [
		"напишите если", "жду вашего ответа", "ждут вашего решения",
		"нет ответа", "не получили ответ", "прекратили общение",
		"диалог не продолжается", "переписка остановилась",
		"контакт потерян", "не выходим на связь", "не отвечает",
		"исчез", "пропал", "перестал отвечать", "забыли", "забыли про кандидата",
		"забыли про вакансию", "не дозвонились", "письмо осталось без ответа",
		"не смогли связаться", "не удалось выйти на контакт", "тишина",
		"молчание", "нет реакции", "нет обратной связи", "не реагирует"
	],

	# 8. Отказ соискателя
	"отказ соискателя от вакансии": [
		"отказываюсь", "передумал", "не готов", "не хочу", "не буду",
		"выбрал другую компанию", "нашел другую работу", "устроился в другое место",
		"изменились обстоятельства", "не подходят условия", "не устраивает",
		"не интересно", "не мое", "не под мой опыт", "не под мои ожидания",
		"не под зарплата", "не под график", "не под локация", "не под формат",
		"не под задачи", "не под команда", "не под корпоративная культура",
		"не подходит", "не нравится", "не устраивает", "не под мои планы",
		"не мой уровень", "не мой стек технологий", "не мой профиль"
	],

	# 9. Оффер отправлен
	"оффер отправлен": [
		"оффер", "offer", "предложение", "высылаем", "отправляем",
		"готовы предложить", "рады предложить", "хотим предложить",
		"можем предложить", "сформировали оффер", "подготовили предложение",
		"условия работы", "ставка", "зарплата", "компенсационный пакет",
		"бонусы", "льготы", "соцпакет", "график работы", "удаленка", "офис",
		"гибрид", "начало работы", "выход на работу", "подписание документов",
		"трудовой договор", "испытательный срок", "поздравляем", "приняты",
		"рады вам", "ждем в команде", "добро пожаловать", "присоединяйтесь"
	],

	# 10. Оффер отклонен
	"оффер отклонен": [
		"отклоняю", "отказываюсь", "не принимаю", "не согласен", "не устраивает",
		"не подходит", "не нравится", "не мое", "не готов", "передумал",
		"изменились обстоятельства", "нашел другой вариант", "выбрал другое",
		"не под условия", "не под зарплату", "не под график", "не под локацию",
		"не под задачи", "не под команду", "не под корпоративную культуру",
		"не под мой уровень", "не под мой опыт", "не под мои ожидания",
		"не под мои планы", "не под мой стек технологий", "не под мой профиль",
		"не под мой образ жизни", "не под мой ритм работы", "не под мой подход"
	],

	# 11. Оффер принят
	"оффер принят": [
		"принимаю", "согласен", "готов", "беру", "да", "ок", "хорошо",
		"устраивает", "нравится", "подходит", "устраивает", "беру вакансию",
		"выхожу на работу", "начинаю", "приступаю", "подписываю", "согласен",
		"готов работать", "готов сотрудничать", "готов присоединиться",
		"рад присоединиться", "жду начала", "жду выходных", "жду документы",
		"жду инструкции", "жду дальнейших указаний", "жду onboarding",
		"жду вводную", "жду знакомство", "жду первый день", "жду старт"
	],

	# 12. Ожидание решения
	"ожидание решения": [
		"ждем", "ожидаем", "рассматриваем", "анализируем", "принимаем решение",
		"обсуждаем", "согласовываем", "уточняем", "проверяем", "изучаем",
		"собираем информацию", "собираем мнения", "собираем feedback",
		"собираем отзывы", "собираем оценки", "собираем заключения",
		"собираем рекомендации", "собираем выводы", "собираем итоги",
		"сообщим", "перезвоним", "напишем", "дадим ответ", "дадим feedback",
		"дадим обратную связь", "дадим заключение", "дадим итог",
		"дадим результат", "дадим решение", "дадим вердикт", "дадим ответ",
		"на этой неделе", "в ближайшее время", "в течение недели",
		"в течение месяца", "как только", "как только примем решение",
		"как только согласуем", "как только уточним", "как только проверим"
	]
}


def detect_dialogue_state(message, last_active_date = None):
	if last_active_date and (datetime.now() - last_active_date).days > 15:
		return "диалог заброшен"
		
	message = message.lower()
	
	coincidences = dict()
	for state in state_patterns.keys():
		coincidences[state] = 0
	
	for state, patterns_list in state_patterns.items():
		for pattern in patterns_list:
			coincidences[state] += (pattern in message)
	
	return max(coincidences.items(), key=lambda x: x[1])[0]

print(detect_dialogue_state("", ))
